<div #modalWrapper></div>

<p *ngIf="mode === 'edit'" class="text-secondary">
    <i class="fa fa-info-circle" aria-hidden="true"></i>
    {{'structuralResourcesTree.helpMessage' | translate}}.
</p>

<button (click)="addNode()" *ngIf="mode === 'edit'" class="btn btn-link">
    <span class="fa fa-plus"></span>
    <span translate="structuralResourcesTree.addNewNode"></span>
</button>

<p-tree
    *ngIf="mode === 'view'"
    (onNodeSelect)="onSelect($event.node)"
    (onNodeUnselect)="onUnselect($event.node)"
    [(selection)]="selectedResources"
    [loading]="!tree || loading"
    [selectionMode]="selectionMode"
    [emptyMessage]="'structuralResourcesTree.noRecordsFound' | translate"
    [value]="tree"
>
    <ng-template let-node pTemplate="default">
        <span class="label">{{node.label}}</span>&nbsp;
        <span *ngIf="node.data.favoriteType === 'externalOperation'; else onlySubscribedUsers" class="subscribed-users">
            ({{'structuralResourcesTree.subscribedUsers' | translate:{amount: node.data.subscribers || 0} }}, {{'structuralResourcesTree.numberOfFilters' | translate:{amount:
            node.data.numberOfFilters || 0} }})
        </span>
        <ng-template #onlySubscribedUsers>
            <span class="subscribed-users"> ({{'structuralResourcesTree.subscribedUsers' | translate:{amount: node.data.subscribers || 0} }}) </span>
        </ng-template>
    </ng-template>
</p-tree>

<p-tree
    *ngIf="['select', 'simpleSelect'].includes(mode)"
    (onNodeSelect)="onSelect($event.node)"
    (onNodeUnselect)="onUnselect($event.node)"
    [(selection)]="selectedResources"
    [loading]="!tree || loading"
    [selectionMode]="selectionMode"
    [emptyMessage]="'structuralResourcesTree.noRecordsFound' | translate"
    [value]="tree"
    [propagateSelectionUp]="propagateSelection"
    [propagateSelectionDown]="propagateSelection"
></p-tree>

<p-tree
    (onNodeDrop)="onNodeDrop($event)"
    *ngIf="mode === 'edit'"
    [draggableNodes]="true"
    [droppableNodes]="true"
    [emptyMessage]="'structuralResourcesTree.noRecordsFound' | translate"
    [loading]="!tree || loading"
    [selectionMode]="selectionMode"
    [value]="tree"
>
    <ng-template let-node pTemplate="default">
        <span class="label mr-2" (dblclick)="editNodeName(node)">{{node.label}}</span>
        <span class="subscribed-users mr-2">({{'structuralResourcesTree.subscribedUsers' | translate:{amount: node.data.subscribers || 0} }})</span>
        <span class="badge badge-secondary mr-2">{{node.data.externalCategories.length}}</span>
        <p-dialog
            *ngIf="node.editMode === 'name'"
            [visible]="true"
            [focusOnShow]="true"
            [modal]="true"
            [dismissableMask]="true"
            [header]="'structuralResourcesTree.editionModal' | translate"
            [resizable]="false"
            [style]="{width: '50vw'}"
            [contentStyle]="{padding: '1.5em 2em'}"
            [appendTo]="modalWrapper"
            (visibleChange)="disableNodeEdit(node)"
        >
            <app-multi-language-input
                *ngIf="allowedLanguages"
                [ngModel]="node.data.name"
                [locales]="allowedLanguages"
                (onEnterKeyDown)="saveNodeName(node, $event)"
            ></app-multi-language-input>
            <p-footer>
                <button type="button" class="btn btn-secondary" (click)="disableNodeEdit(node)">
                    <i class="fa fa-times" aria-hidden="true"></i>
                    <span>{{ 'entity.action.cancel' | translate }}</span>
                </button>
                <button type="button" class="btn btn-primary" (click)="saveNodeName(node, languageInputComponent.value)">
                    <i class="fa fa-save" aria-hidden="true"></i>
                    <span>{{ 'entity.action.save' | translate }}</span>
                </button>
            </p-footer>
        </p-dialog>
        <p-dialog
            *ngIf="node.editMode === 'remap'"
            [visible]="true"
            [focusOnShow]="true"
            [modal]="true"
            [dismissableMask]="true"
            [header]="'structuralResourcesTree.remapModal' | translate"
            [resizable]="false"
            [style]="{width: '80vw'}"
            [contentStyle]="{padding: '0', 'overflow-y': 'auto'}"
            [appendTo]="modalWrapper"
            (visibleChange)="disableNodeEdit(node)"
        >
            <app-external-categories-table
                #table
                [selectedExternalCategories]="node.data.externalCategories"
                [disabledExternalCategories]="getDisabledExternalCategories(node.data)"
            ></app-external-categories-table>
            <p-footer>
                <button (click)="disableNodeEdit(node)" class="btn btn-secondary" type="button">
                    <i class="fa fa-times" aria-hidden="true"></i>
                    <span>{{ 'entity.action.cancel' | translate }}</span>
                </button>
                <button type="button" class="btn btn-primary" (click)="saveRemap(node, table.getSelectedResources())">
                    <i class="fa fa-save" aria-hidden="true"></i>
                    <span>{{ 'entity.action.save' | translate }}</span>
                </button>
            </p-footer>
        </p-dialog>
        <button type="button" class="btn btn-info node-btn-sm mr-2">
            <i class="fa fa-search" aria-hidden="true" (click)="remapNode(node)"></i>
        </button>
        <button type="button" class="btn btn-primary node-btn-sm mr-2" (click)="addNode(node)">
            <i class="fa fa-plus" aria-hidden="true"></i>
        </button>
        <button type="button" class="btn btn-danger node-btn-sm" (click)="deleteNode(node)">
            <i class="fa fa-minus" aria-hidden="true"></i>
        </button>
    </ng-template>
</p-tree>
